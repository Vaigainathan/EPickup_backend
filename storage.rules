rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions for role-based access control
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth != null && 
        (request.auth.token.role == 'super_admin' || 
         request.auth.token.appType == 'admin');
    }
    
    function isDriver() {
      return request.auth != null && 
        (request.auth.token.role == 'driver' || 
         request.auth.token.appType == 'driver');
    }
    
    function isCustomer() {
      return request.auth != null && 
        (request.auth.token.role == 'customer' || 
         request.auth.token.appType == 'customer');
    }
    
    // Universal ownership check - handles both Firebase UID and role-based UID
    function isOwner(userId) {
      return request.auth != null && 
        (request.auth.uid == userId || 
         request.auth.token.roleBasedUID == userId);
    }
    
    // Driver documents - NEW structured path
    match /drivers/{driverId}/documents/{documentType}/{document=**} {
      allow read: if isAuthenticated() && 
        ((isDriver() && isOwner(driverId)) || isAdmin());
      allow write: if isAuthenticated() && 
        ((isDriver() && isOwner(driverId)) || isAdmin());
    }
    
    // Driver documents - LEGACY path (TEMPORARILY PERMISSIVE)
    match /driver-documents/{userId}/{document=**} {
      allow read: if isAuthenticated() && isDriver();
      allow write: if isAuthenticated() && isDriver();
    }
    
    // Profile photos - universal access
    match /profiles/{userId}/{document=**} {
      allow read: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
    }
    
    // Customer documents
    match /customers/{customerId}/documents/{documentType}/{document=**} {
      allow read: if isAuthenticated() && 
        ((isCustomer() && isOwner(customerId)) || isAdmin());
      allow write: if isAuthenticated() && 
        ((isCustomer() && isOwner(customerId)) || isAdmin());
    }
    
    // Verification photos (for bookings)
    match /verifications/{bookingId}/{document=**} {
      allow read: if isAuthenticated() && 
        (isDriver() || isCustomer() || isAdmin());
      allow write: if isAuthenticated() && 
        (isDriver() || isCustomer() || isAdmin());
    }
    
    // Public documents - read-only for all, write for admin only
    match /public/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated() && isAdmin();
    }
    
    // Admin access to all documents (catch-all rule - must be last)
    match /{allPaths=**} {
      allow read, write: if isAuthenticated() && isAdmin();
    }
  }
}
