rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions for role-based access control
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth != null && 
        (request.auth.token.role == 'super_admin' || 
         request.auth.token.appType == 'admin');
    }
    
    function isDriver() {
      return request.auth != null && 
        (request.auth.token.role == 'driver' || 
         request.auth.token.appType == 'driver');
    }
    
    function isCustomer() {
      return request.auth != null && 
        (request.auth.token.role == 'customer' || 
         request.auth.token.appType == 'customer');
    }
    
    // Universal ownership check - handles both Firebase UID and role-based UID
    function isOwner(userId) {
      return request.auth != null && 
        (request.auth.uid == userId || 
         request.auth.token.roleBasedUID == userId);
    }
    
    // Driver documents - NEW structured path (MORE PERMISSIVE FOR UPLOADS)
    match /drivers/{driverId}/documents/{documentType}/{document=**} {
      allow read: if isAuthenticated() && 
        ((isDriver() && isOwner(driverId)) || isAdmin());
      allow write: if isAuthenticated() && 
        ((isDriver() && isOwner(driverId)) || isAdmin() || 
         (isDriver() && request.auth.uid == driverId));
    }
    
    // ✅ CRITICAL FIX: Legacy driver-documents path removed - no longer used
    
    // User files (profile photos, documents, etc.) - NEW path used by backend
    match /users/{userId}/{allFiles=**} {
      allow read: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
    }
    
    // Profile photos - universal access (LEGACY path)
    match /profiles/{userId}/{document=**} {
      allow read: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
    }
    
    // Customer documents
    match /customers/{customerId}/documents/{documentType}/{document=**} {
      allow read: if isAuthenticated() && 
        ((isCustomer() && isOwner(customerId)) || isAdmin());
      allow write: if isAuthenticated() && 
        ((isCustomer() && isOwner(customerId)) || isAdmin());
    }
    
    // Verification photos (for bookings)
    // ✅ CRITICAL FIX: Handle both Firebase UID and role-based UID for driver matching
    // ✅ SECURITY: Enforce booking lifecycle and user isolation
    match /verifications/{bookingId}/{document=**} {
      // Helper function to get booking data
      function getBooking() {
        return firestore.get(/databases/(default)/documents/bookings/$(bookingId));
      }
      
      // Helper function to check if booking exists
      function bookingExists() {
        return firestore.exists(/databases/(default)/documents/bookings/$(bookingId));
      }
      
      // ✅ CRITICAL FIX: Check if booking is active (not completed/cancelled)
      // ✅ SECURITY: Prevents uploads after booking lifecycle has ended
      function isBookingActive() {
        return bookingExists() && 
               getBooking().data.status != 'completed' &&
               getBooking().data.status != 'cancelled';
      }
      
      // Helper function to check if user is driver of booking (handles both UID types)
      // ✅ ISOLATION: Ensures driver can only access their assigned booking
      function isDriverOfBooking() {
        return bookingExists() &&
               (getBooking().data.driverId == request.auth.uid ||
                getBooking().data.driverId == request.auth.token.roleBasedUID);
      }
      
      // Helper function to check if user is customer of booking
      // ✅ ISOLATION: Ensures customer can only access their own booking
      function isCustomerOfBooking() {
        return bookingExists() &&
               (getBooking().data.customerId == request.auth.uid ||
                getBooking().data.customerId == request.auth.token.roleBasedUID);
      }
      
      // ✅ ISOLATION: Only allow participants of the booking to read
      // ✅ LIFECYCLE: Allow read even if booking is completed (for viewing history)
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (bookingExists() && (isDriverOfBooking() || isCustomerOfBooking()))
      );
      
      // ✅ CRITICAL FIX: Only allow driver assigned to booking to write
      // ✅ SECURITY: Must be active booking (not completed/cancelled)
      // ✅ ISOLATION: Driver can only upload to their assigned booking
      allow write: if isAuthenticated() && (
        isAdmin() ||
        (isDriver() && isDriverOfBooking() && isBookingActive())
      );
    }
    
    // Public documents - read-only for all, write for admin only
    match /public/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated() && isAdmin();
    }
    
    // Admin access to all documents (catch-all rule - must be last)
    match /{allPaths=**} {
      allow read, write: if isAuthenticated() && isAdmin();
    }
  }
}
